##
# Ansible playbook for setting up a Training Wheels server in EC2, for
# our auto build system.
#

---
- hosts: all
  gather_facts: False

  vars:
    twdir: '/var/trainingwheels'

  tasks:
    ##
    # Update the machine
    #
    - name: Update apt
      action: apt update-cache=yes

    - name: Change the hostname in /etc/hosts
      action: template src=etc-hosts.j2 dest=/etc/hosts owner=root group=root mode=0644

    - name: Change the hostname in /etc/hostname
      action: template src=etc-hostname.j2 dest=/etc/hostname owner=root group=root mode=0644

    - name: Change the hostname using the hostname command
      action: command hostname tw-$server.com

    - name: Install required packages for Jenkins slave and general use
      action: apt pkg=$item state=installed
      with_items:
        - git
        - openjdk-7-jre-headless
        - python-pip

    # We must setup the bender user after doing the Java install, otherwise
    # Jenkins will build it's own version of Java as the slave connects.
    - name: Create bender group
      action: group name=bender
      when_string: $server == 'build'

    - name: Create bender user for Jenkins to connect with
      action: "user name=bender home=/home/bender groups=admin,bender group=bender shell=/bin/bash"
      when_string: $server == 'build'

    - name: SSH folder for bender
      action: file path=/home/bender/.ssh state=directory owner=bender group=bender mode=755
      when_string: $server == 'build'

    - name: Copy authorized keys for bender
      action: copy src=bender_authorized_keys dest=/home/bender/.ssh/authorized_keys owner=bender group=bender mode=644
      when_string: $server == 'build'

    # Training Wheels app download and setup
    - name: Clone the repo
      action: git repo=https://github.com/trainingwheels/trainingwheels.git dest=$twdir version=$branch

    - name: Let web user write to log file directory
      action: file state=directory path=$twdir/controller/log mode=0777

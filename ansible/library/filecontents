#!/usr/bin/python

# (c) 2012, Mark Theunissen <mark.theunissen@gmail.com>
# Sponsored by Four Kitchens http://fourkitchens.com.
#
# This file is part of the Aurai application, providing commands
# for use in Training Wheels.
#
# Aurai is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# Aurai is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Aurai.  If not, see <http://www.gnu.org/licenses/>.

#
# Usage:
#
# path='/path/to/file'
#   Returns the file contents from /path/to/file.
#
# path='/path/to/file' action='append' text='some text'
#   Appends 'some text' to the file '/path/to/file' and returns the result.
#
# path='/path/to/file' action='overwrite' text='some text'
#   Overwrite the file at '/path/to/file' with the text 'some text', returns the result.

def main():
    module = AnsibleModule(
        argument_spec = dict(
            path=dict(required=True),
            action=dict(default="get", choices=["get","append","overwrite","replace"]),
            text=dict(default=None),
            old=dict(default=None),
            new=dict(default=None)
        )
    )
    action = module.params["action"]
    path = module.params["path"]
    text = module.params["text"]
    old = module.params["old"]
    new = module.params["new"]

    if action == "overwrite" or action == "append":
        if text is None:
            module.fail_json(msg='when overwriting or appending, you must provide a text= argument')

    try:
        if action == "append":
            file = open(path, 'a+')
            file.write("\n" + text + "\n")
        elif action == "overwrite":
            file = open(path, 'w+')
            file.write(text)
        elif action == "get":
            file = open(path, 'r')
        elif action == "replace":
            if old is None or new is None:
                module.fail_json(msg='replace action requires new= and old= arguments')
            sourcefile = open(path, 'r')
            text = sourcefile.read()
            text = text.replace(old, new)
            sourcefile.close()
            file = open(path, 'w+')
            file.write(text)
        file.flush()
        file.seek(0)
        file_contents = file.read()
        file.close()
        module.exit_json(contents=file_contents)

    except IOError as e:
        module.fail_json(msg='file IO error')

# this is magic, see lib/ansible/module_common.py
#<<INCLUDE_ANSIBLE_MODULE_COMMON>>
main()

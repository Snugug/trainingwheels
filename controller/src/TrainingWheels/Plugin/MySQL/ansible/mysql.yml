##
# Ansible playbook plugin for MySQL resource.
#
# Vars passed in are:
#
# $admin_user
# $admin_user_home
#

---
- hosts: all

  tasks:
    ##
    # Apt package installation of required software.
    #
    - name: MySQL | Install required packages.
      action: apt pkg=$item state=installed
      with_items:
        - mysql-server
        - mysql-client
        - python-mysqldb

    ##
    # MySQL database setup.
    #
    - name: MySQL configuration file my.cnf
      action: template src=templates/etc-mysql-my-cnf.j2 dest=/etc/mysql/my.cnf

    - name: Set the root password.
      action: mysql_user user=root password=$mysql_root_password host=localhost

    - name: MySQL config for easy access as root user.
      action: template src=templates/root-my-cnf.j2 dest=/root/.my.cnf

    - name: MySQL config for easy access as admin user and so that this playbook can be run again.
      action: template src=templates/root-my-cnf.j2 dest=$admin_user_home/.my.cnf

    - name: Delete anonymous MySQL server user for full qualified domain
      action: mysql_user user="" host=$ansible_fqdn state=absent

    - name: Delete anonymous MySQL server user for localhost
      action: mysql_user user="" state=absent

    - name: Secure the MySQL root user for IPV6 localhost (::1)
      action: mysql_user user=root password=$mysql_root_password host=::1

    - name: Secure the MySQL root user for IPV4 localhost (127.0.0.1)
      action: mysql_user user=root password=$mysql_root_password host=127.0.0.1

    - name: Secure the MySQL root user for localhost domain (localhost)
      action: mysql_user user=root password=$mysql_root_password host=localhost

    - name: Secure the MySQL root user for full qualified domain
      action: mysql_user user=root password=$mysql_root_password host=$ansible_fqdn

    - name: Remove the MySQL test database
      action: mysql_db db=test state=absent

    ##
    # Restart services
    #
    - name: Restart MySQL
      action: service name=mysql state=restarted

##
# Ansible playbook plugin for MySQL resource.
#

---
- hosts: all
  gather_facts: False

  vars_files:
    - mysql-default-settings.yml

  tasks:
    ##
    # Apt package installation of required software.
    #
    - name: MySQL | Install required packages.
      action: apt pkg=$item state=installed
      with_items:
        - mysql-server
        - mysql-client
        - python-mysqldb

    ##
    # MySQL database setup.
    #
    - name: MySQL configuration file my.cnf
      action: template src=templates/etc-mysql-my-cnf.j2 dest=/etc/mysql/my.cnf

    - name: Set the root password.
      action: mysql_user user=root password=$mysql_root_password host=localhost

    - name: MySQL config for easy access as root user and so that this playbook can be run again.
      action: template src=templates/root-my-cnf.j2 dest=/root/.my.cnf

    - name: Delete anonymous MySQL server user for $server_hostname
      action: mysql_user user="" host=$server_hostname state=absent

    - name: Delete anonymous MySQL server user for localhost
      action: mysql_user user="" state=absent

    - name: Secure the MySQL root user for IPV6 localhost (::1)
      action: mysql_user user=root password=$mysql_root_password host=::1

    - name: Secure the MySQL root user for IPV4 localhost (127.0.0.1)
      action: mysql_user user=root password=$mysql_root_password host=127.0.0.1

    - name: Secure the MySQL root user for localhost domain (localhost)
      action: mysql_user user=root password=$mysql_root_password host=localhost

    - name: Secure the MySQL root user for $server_hostname domain
      action: mysql_user user=root password=$mysql_root_password host=$server_hostname

    - name: Remove the MySQL test database
      action: mysql_db db=test state=absent

    ##
    # Restart services
    #
    - name: Restart MySQL
      action: service name=mysql state=restarted

##
# Ansible playbook for Cloud9 IDE plugin.
#

---
- hosts: all
  gather_facts: False

  tasks:
    ##
    # Setup Cloud9 IDE
    #
    - name: Cloud9 | Ensure required Ubuntu packages are installed
      action: apt pkg=$item state=installed
      with_items:
        - build-essential
        - g++
        - curl
        - libssl-dev
        - apache2-utils
        - git
        - libxml2-dev
        - supervisor

    - name: Cloud9 | Grab the repository
      action: git repo=https://github.com/ajaxorg/cloud9.git dest=$path version=$version

    - name: Cloud9 | Install Source Mint to build Cloud 9
      action: command npm install -g sm creates=/usr/bin/sm

    - name: Cloud9 | Build Cloud9
      action: command sm install chdir=$path creates=$path/node_modules

    - name: Cloud9 | Add a supervisor configuration for a root cloud9 process
      action: copy src=etc-supervisor-conf-d-cloud9-root-conf dest=/etc/supervisor/conf.d/cloud9-root.conf

    - name: Cloud9 | Get supervisor to read the new config file
      action: command supervisorctl reread

    - name: Cloud9 | Get supervisor to update with the new config
      action: command supervisorctl update

    - name: Cloud9 | Run the cloud9 app as root once as it auto-configures itself on first run
      action: supervisorctl name=cloud9-root state=started

    - name: Cloud9 | Wait for the port to be open and listening
      action: wait_for port=3131 delay=1

    - name: Cloud9 | Stop the root cloud9 app
      action: supervisorctl name=cloud9-root state=stopped

    # See: https://github.com/ajaxorg/cloud9/issues/2005
    - name: Cloud9 | Make a writable sessions directory for Cloud9
      action: file path=$path/.sessions mode=777 owner=root group=root state=directory

    - name: Cloud9 | Remove the root config file
      action: file path=/etc/supervisor/conf.d/cloud9-root.conf state=absent

    - name: Cloud9 | Get supervisor to read the new config
      action: command supervisorctl reread

    - name: Cloud9 | Get supervisor to update with the new config
      action: command supervisorctl update
